{% extends 'base.html' %}
{% block content %}

<!-- Header-->
<header class="bg-dark py-1">
    <div class="container px-2 px-lg-5 my-5">
        <div class="text-center text-white">
            <h1 class="display-4 fw-bolder">Search Products</h1>
            <p class="lead fw-normal text-white-50 mb-0">Find What You're Looking For...</p>
        </div>
    </div>
</header>

<div class="container">
    <div class="row">
        <div class="col-5">
            <br/><br/>
            <div class="card">
                <div class="card-header">
                    Search Products
                </div>
                <div class="card-body">
                    <form method="POST" action="{% url 'search' %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <input type="text" class="form-control" placeholder="Search For Products" name="searched">
                        </div>
                        <button type="submit" class="btn btn-secondary">
                            Search Products
                        </button>
                    </form>
                </div>
            </div>
<!-- Cart Summary Card -->
    <div class="col-md-5 offset-md-2"></div>
            <br/><br/>
            <div class="card">
                <div class="card-header">
                    Cart Summary
                </div>
                <div class="card-body">
                    {% if cart_products %}
                    <ul class="list-group">
                        {% for product in cart_products %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ product.name }}
                                    <span>Qty: {{ product.quantity }}</span>
                                    <span>${{ product.total_price }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                        <hr>
                        <h5 class="text-end">Total: ${{ cart_total }}</h5>
                        <a href="{% url 'checkout' %}" class="btn btn-success w-100">Checkout</a>
                    {% else %}
                        <p>Your cart is empty.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
            <br/><br/>
            <br/><br/>
        </div>
        
            {% if searched %}
    <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Product Name</th>
                            <th scope="col">Price</th>
                            <th scope="col">Sale Price</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in searched %}
                            <tr>
                                <td>{{ product.name }}</td>
                                <td>
                                    {% if product.is_sale %}
                                        <strike>${{ product.price }}</strike>
                                    {% else %}
                                        ${{ product.price }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if product.is_sale %}
                                        ${{ product.sale_price }}
                                    {% else %}
                                        ${{ product.price }}
                                    {% endif %}
                                </td>
                                <td>
                                    <a class="btn btn-outline-dark" href="{% url 'product' product.id %}">View</a>
                                    <button type="button" value="{{ product.id }}" class="btn btn-secondary" id="add-cart">Add To Cart</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No products found.</p>
            {% endif %}
        </div>
    </div>
</div>

<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>

<script>
    // Check if button pressed
    $(document).on('click', '#add-cart', function(e){
        e.preventDefault();
        
        // Get the product ID from the clicked button
        var productId = $(this).val();
        
        // Default quantity (since there is no quantity dropdown on the search page)
        var productQty = 1;  // Set this to a default value or create logic to handle quantities
        
        $.ajax({
            type: 'POST',
            url: '{% url 'cart_add' %}',
            data: {
                product_id: productId,
                product_qty: productQty,
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action: 'post'
            },
            success: function(json){
                // Update the cart quantity display
                document.getElementById("cart_quantity").textContent = json.qty;
                location.reload();
            },
            error: function(xhr, errmsg, err){
                // Handle errors if needed
                console.log(errmsg);
            }
        });
    });
</script>
<script>
    $(document).ready(function(){
        // Get the search query from the template
        var query = '{{ query|escapejs }}';  // Use Django's escapejs filter to safely handle special characters
        
        // Check if there's a matching product in the search results
        {% for product in searched %}
            var productName = '{{ product.name|escapejs }}';

            // If the product name matches the search query, automatically add it to the cart
            if (productName.toLowerCase() === query.toLowerCase()) {
                var productId = '{{ product.id }}';  // Get the product ID
                var productQty = 1;  // Set a default quantity (can adjust if needed)

                // Trigger the AJAX request to add the product to the cart
                $.ajax({
                    type: 'POST',
                    url: '{% url 'cart_add' %}',
                    data: {
                        product_id: productId,
                        product_qty: productQty,
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        action: 'post'
                    },
                    success: function(json) {
                        // Update the cart quantity display
                        document.getElementById("cart_quantity").textContent = json.qty;
                        location.reload();  // Reload the page to show updated cart
                    },
                    error: function(xhr, errmsg, err) {
                        console.log('Error adding product to cart: ' + errmsg);
                    }
                });
            }
        {% endfor %}
    });
</script>


    
{% endblock %}
